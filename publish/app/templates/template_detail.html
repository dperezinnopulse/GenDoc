{% extends "base.html" %}
{% block subnav %}
<a href="/admin/templates/{{ template.id }}" class="active">Resumen</a>
<a href="/admin/templates/{{ template.id }}/overlay">Editor visual</a>
<a href="/admin/templates/{{ template.id }}/markers">Editar marcadores</a>
<a href="#">Mapeo/Secciones</a>
<a href="/admin/templates/{{ template.id }}/test_render" target="_blank">Prueba PDF</a>
<a href="/admin/templates/{{ template.id }}/test_render?format=image" target="_blank">Prueba PNG</a>
{% endblock %}
{% block content %}
<div>
  <h1>{{ template.name }}</h1>
  <p>Tipo: {{ template.kind }} | ID: {{ template.id }}</p>
  {% if error %}<div class="error">{{ error }}</div>{% endif %}

  <h2>Mapeo de campos</h2>
  <form method="post" action="/admin/templates/{{ template.id }}/save_mapping">
    <label>Mapping (JSON). Ej: {"nombre": "alumno.nombre"}</label>
    <textarea name="mapping_json" rows="6" style="width:100%;">{{ template.mapping | tojson(indent=2) }}</textarea>

    <label>Secciones repetidas (JSON)</label>
    <textarea name="repeat_json" rows="6" style="width:100%;">{{ template.repeat_sections | tojson(indent=2) }}</textarea>

    <label>Schema de validaci√≥n (JSON Schema)</label>
    <textarea name="schema_json" rows="10" style="width:100%;">{{ template.schema | tojson(indent=2) }}</textarea>

    <button type="submit">Guardar</button>
  </form>

  {% if template.mapping._images %}
  <h2>Campos de imagen</h2>
  <div style="background:#f7fafc; padding:12px; border-radius:8px; margin:12px 0;">
    <p><strong>Campos de imagen configurados:</strong></p>
    <ul>
    {% for key, meta in template.mapping._images.items() %}
      <li><strong>{{ key }}</strong>: Posici√≥n ({{ meta.x }}, {{ meta.y }}), Tama√±o {{ meta.width }}x{{ meta.height }}</li>
    {% endfor %}
    </ul>
    <p><small>üí° Los campos de imagen aceptan URLs (https://...) o im√°genes base64. Se pueden editar en el <a href="/admin/templates/{{ template.id }}/overlay">Editor visual</a> o en <a href="/admin/templates/{{ template.id }}/markers">Editar marcadores</a>.</small></p>
  </div>
  {% endif %}

  <h2>Prueba de render</h2>
  <form method="post" action="/admin/templates/{{ template.id }}/test_render" target="_blank">
    <label>Datos (JSON)</label>
    <textarea name="data_json" rows="12" style="width:100%;">{{ suggested_data or '{\n  "nombre": "Ana"\n}' }}</textarea>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <button type="submit" name="format" value="pdf">Generar PDF</button>
      <button type="submit" name="format" value="image">Generar PNG</button>
    </div>
  </form>
</div>
{% endblock %}